---
- hosts: localhost
  vars:
    vault_keys:  "{{ lookup('env','VAULT_KEYS').split(' ')[0:3] }}"
  tasks:
    - hashivault_status:
      register: 'vault_status'
    - assert: { that: "{{vault_status.changed}} == False" }
    - assert: { that: "{{vault_status.rc}} == 0" }

    - block:
        - hashivault_seal:
          register: 'vault_seal'
        - assert: { that: "{{vault_seal.changed}} == True" }
        - assert: { that: "{{vault_seal.rc}} == 0" }
      when: "{{vault_status.status.sealed}} == False"

    - hashivault_unseal:
        key: '{{item}}'
      register: 'vault_unseal'
      with_items: "{{vault_keys}}"
    - assert: { that: "{{vault_unseal.changed}} == True" }
    - assert: { that: "{{vault_unseal.results[-1].status.progress}} == 0" }
    - assert: { that: "{{vault_unseal.results[-1].status.sealed}} == False" }
    - assert: { that: "{{vault_unseal.results[-1].rc}} == 0" }
